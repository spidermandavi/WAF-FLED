<script>
const TOURNAMENTS = [
  "ZLfbxNcu",
  "Z2DuzTxs",
  "O4X6VErR",
  "HVMkt9VQ" // upcoming â†’ ignored
];

function parsePGN(pgn) {
  const w = pgn.match(/\[White "(.+?)"]/);
  const b = pgn.match(/\[Black "(.+?)"]/);
  if (!w || !b) return []; // â† CRITICAL FIX

  const white = w[1];
  const black = b[1];
  const termination = pgn.match(/\[Termination "(.+?)"]/)?.[1] || "";

  let whiteRes = "draw";
  let blackRes = "draw";

  if (pgn.includes("1-0")) {
    whiteRes = "win";
    blackRes = "loss";
  } else if (pgn.includes("0-1")) {
    whiteRes = "loss";
    blackRes = "win";
  }

  if (termination.includes("Time forfeit")) {
    if (whiteRes === "win") whiteRes = "flag_win";
    if (blackRes === "win") blackRes = "flag_win";
    if (whiteRes === "loss") whiteRes = "flag_loss";
    if (blackRes === "loss") blackRes = "flag_loss";
  }

  return [
    { name: white, res: whiteRes },
    { name: black, res: blackRes }
  ];
}

async function fetchGames(id) {
  try {
    const r = await fetch(`https://lichess.org/api/tournament/${id}/games`);
    const txt = await r.text();
    if (!txt.trim()) return [];

    return txt
      .split(/\n(?=\[Event)/)
      .flatMap(parsePGN);
  } catch (e) {
    console.error("Failed to fetch games:", e);
    return [];
  }
}

async function buildAchievements() {
  const players = {};

  for (const tmt of TOURNAMENTS) {
    const games = await fetchGames(tmt);
    if (!games.length) continue;

    games.forEach(g => {
      if (!players[g.name]) {
        players[g.name] = {
          name: g.name,
          waffles: 0,
          waffled: 0,
          games: 0
        };
      }

      if (g.res === "flag_win") players[g.name].waffles++;
      if (g.res === "flag_loss") players[g.name].waffled++;
      players[g.name].games++;
    });
  }

  const list = Object.values(players);

  buildPodium("podium-waffles", list, "waffles");
  buildPodium("podium-waffled", list, "waffled");
  buildPodium("podium-committed", list, "games", true);
}

function buildPodium(id, data, key, formatGames = false) {
  const medals = ["ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰"];
  const container = document.getElementById(id);

  if (!data.length) {
    container.innerHTML = "<p class='loading'>No data yet!</p>";
    return;
  }

  const top3 = [...data]
    .sort((a, b) => b[key] - a[key])
    .slice(0, 3);

  container.innerHTML = top3.map((p, i) => `
    <div class="podium-slot place-${i + 1}">
      <div class="trophy">${medals[i]}</div>
      <div class="name">${p.name}</div>
      <div class="value">
        ${formatGames ? p[key] + " games" : p[key]}
      </div>
    </div>
  `).join("");
}

buildAchievements();
</script>
